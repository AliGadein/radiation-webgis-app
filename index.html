<!doctype html>
<html lang="en">
<head>
<title>OSGIS App: TIN, buffer, select</title>
<!-- website layout css -->
<link rel="stylesheet" href="Includes/style.css" type="text/css">
<!-- ol3 css -->
<link rel="stylesheet" href="Includes/plugins/ol3/ol.css" type="text/css">
<!-- turf js -->
<script src="Includes/plugins/turf/turf.min.js"></script>
<!-- ol3 js -->
<script src="Includes/plugins/ol3/ol.js"></script>
<!-- jquery -->
<!--<script type="text/javascript" src="Includes/plugins/jquery/jquery-3.1.1.js"></script>-->
<!-- style functionality -->
<script src="Includes/style.js"></script>

<link rel="stylesheet" href="Includes/ol/extension-layerswitcher/ol3-layerswitcher.css" type="text/css">
<script src="Includes/ol/extension-layerswitcher/ol3-layerswitcher.js"></script>

<link rel="stylesheet" href="Includes/ol/extension-popup/ol3-popup.css" type="text/css">
<script src="Includes/ol/extension-popup/ol3-popup.js"></script>

<script src="Includes/layerhandler.js"></script>
<script src="Includes/turf-buffer-circle-fix.js"></script>

<!-- layout -->
<link href="Includes/bootstrap-jqueryui/assets/css/bootstrap.min.css" rel="stylesheet">
<link type="text/css" href="Includes/bootstrap-jqueryui/css/custom-theme/jquery-ui-1.10.0.custom.css" rel="stylesheet" />
<link type="text/css" href="Includes/bootstrap-jqueryui/assets/css/font-awesome.min.css" rel="stylesheet" />
<link href="Includes/bootstrap-jqueryui/assets/js/google-code-prettify/prettify.css" rel="stylesheet">
<script src="Includes/bootstrap-jqueryui/assets/js/jquery-1.9.0.min.js" type="text/javascript"></script>
<script src="Includes/bootstrap-jqueryui/assets/js/bootstrap.min.js" type="text/javascript"></script>
<script src="Includes/bootstrap-jqueryui/assets/js/jquery-ui-1.10.0.custom.min.js" type="text/javascript"></script>
<script src="Includes/bootstrap-jqueryui/assets/js/google-code-prettify/prettify.js" type="text/javascript"></script>

</head>

<body>

<!-- layout --> 

<!-- Tool bar -->  

<div id="gis_toolbar" class="ui-widget-content panel">
    <button class="btn " id="tool_buffer">Buffer</button>
    <button class="btn " id="tool_union">Union</button>
    <button class="btn " id="tool_within">Within</button>
    <button class="btn " id="tool_nearest">Nearest</button>
    <button class="btn " id="tool_voronoi">Voronoi</button>
</div>

<!-- Layer switcher --> 
<div id="gis_layer_switcher" style="display: none;" class="ui-widget-content panel">
    <h4>Layers</h4>
    <hr>
    <div id="layer_list">

	<ul id="sortable1" class="connectedSortable">
	  <li>Item 1</li>
	  <li>Item 2</li>
	  <li>Item 3</li>
	  <li>Item 4</li>
	  <li>Item 5</li>
	</ul>

	<ul id="sortable2" class="connectedSortable">
	  <li>Item 1</li>
	  <li>Item 2</li>
	  <li>Item 3</li>
	  <li>Item 4</li>
	  <li>Item 5</li>
	</ul>

    </div>
    <hr>
</div>
<!-- Dialog for Buffer -->
<div id="dialog-buffer-tool" title="Buffer tool">
    
    <p class="validateTips">All form fields are required.</p>
    
    <form class="" id="form-buffer-tool">
	<fieldset class="row-fluid">
	    
	    <label for="buffer_layer_name"><b>Layer name</b></label>
	    <input type="text" name="buffer_layer_name" id="buffer_layer_name" placeholder="Name the new layer" class="span12">
	    
	    <label for="buffer_layer_title"><b>Layer title</b></label>
	    <input type="text" name="buffer_layer_title" id="buffer_layer_title" placeholder="Give a title" class="span12">
	    
	    <label><b>Details</b></label>
	    <div class="form-inline">
		
		    <input type="number" name="buffer_layer_distance" id="buffer_layer_distance" placeholder="Buffer distance">
		
		    <select name="buffer_layer_unit" id="buffer_layer_unit">
			<option>kilometers</option>
			<option>miles</option>
		    </select>
	    </div>
	    <br>
	    <div class="form-inline">
		<select name="buffer_layer_selectable" id="buffer_layer_selectable">
		    <option value="false">Not selectable</option>
		    <option value="true">Selectable</option>
		</select>
	    </div>

	  <input type="submit" tabindex="-1" style="position:absolute; top:-1000px">
	</fieldset>
    </form>
</div>

<!-- Dialog for Union -->
<div id="dialog-union-tool" title="Union tool">
    
    <p class="validateTips">All form fields are required.</p>
    
    <form class="" id="form-union-tool">
	<fieldset class="row-fluid">
	    
	    <label for="union_layer_name"><b>Layer name</b></label>
	    <input type="text" name="union_layer_name" id="union_layer_name" placeholder="Name the new layer" class="span12">
	    
	    <label for="union_layer_title"><b>Layer title</b></label>
	    <input type="text" name="union_layer_title" id="union_layer_title" placeholder="Give a title" class="span12">

	    <br>
	   
	    <label for="union_layer_title"><b>Selection options</b></label>
	    <select name="union_layer_selectable" id="union_layer_selectable">
		<option value="false">Not selectable</option>
		<option value="true">Selectable</option>
	    </select>
	    

	  <input type="submit" tabindex="-1" style="position:absolute; top:-1000px">
	</fieldset>
    </form>
</div>

<!-- Dialog for Within -->
<div id="dialog-within-tool" title="Within tool">
    
    <p class="validateTips">All form fields are required.</p>
    
    <form class="" id="form-within-tool">
	<fieldset class="row-fluid">
	    
	    <label for="within_layer_name"><b>Layer name</b></label>
	    <input type="text" name="within_layer_name" id="within_layer_name" placeholder="Name the new layer" class="span12">
	    
	    <label for="within_layer_title"><b>Layer title</b></label>
	    <input type="text" name="within_layer_title" id="within_layer_title" placeholder="Give a title" class="span12">

	    <br>
	   
	    <label for="within_layer_title"><b>Selection options</b></label>
	    <select name="within_layer_selectable" id="within_layer_selectable">
		<option value="false">Not selectable</option>
		<option value="true">Selectable</option>
	    </select>
	    

	  <input type="submit" tabindex="-1" style="position:absolute; top:-1000px">
	</fieldset>
    </form>
</div>

<!-- Dialog for Nearest -->
<div id="dialog-nearest-tool" title="Nearest tool">
    
    <p class="validateTips">All form fields are required.</p>
    
    <form class="" id="form-nearest-tool">
	<fieldset class="row-fluid">
	    
	    <label for="nearest_layer_name"><b>Layer name</b></label>
	    <input type="text" name="nearest_layer_name" id="nearest_layer_name" placeholder="Name the new layer" class="span12">
	    
	    <label for="nearest_layer_title"><b>Layer title</b></label>
	    <input type="text" name="nearest_layer_title" id="nearest_layer_title" placeholder="Give a title" class="span12">

	    <br>
	   
	    <label for="nearest_layer_title"><b>Selection options</b></label>
	    <select name="nearest_layer_selectable" id="nearest_layer_selectable">
		<option value="false">Not selectable</option>
		<option value="true">Selectable</option>
	    </select>
	    

	  <input type="submit" tabindex="-1" style="position:absolute; top:-1000px">
	</fieldset>
    </form>
</div>

<!-- map window's div -->   
<div id="map"></div>
 
<!-- init -->
<script type="text/javascript">

var LH = new LayerHandler();

// Collection of currently selected features
var SelectedFeatures = new ol.Collection(); 

// Collection of Map interactions
var Interactions = new ol.Collection(); 

// Collection of Map controls
var Controls = new ol.Collection();

// Collection of Map overlays
var Overlays = new ol.Collection();

// Select interaction
var InteractionSelect = new ol.interaction.Select({
    features: SelectedFeatures,
    layers: function(layer) {
	return layer.get('selectable') === true;
    }
    //style
});

// New selection happened
InteractionSelect.on('select', function(){
    InteractionSelect.changed();
});

// Selected feature collection has been updated
InteractionSelect.on('change', function(){
    SelectedFeatures.changed();
});

// Add the interaction to the collection and to the map
Interactions.push(InteractionSelect);
/*
SelectedFeatures.on('change', function(){
    
    LH.addLayer({
	layer_name: "Buffers",
	selectable: false,
	group_name: "base_data_group",
	title: "Buffers",
	style: new ol.style.Style({
	    stroke: new ol.style.Stroke({
		color: 'red',
		width: 5
	    }),
	    fill: new ol.style.Fill({
		color: 'rgba(255, 0, 0, 0.7)'
	    })
	})
    });
    
    this.forEach(function(feature, index, array) {
	
        var geojson = LH.formatFeatureToGeoJson(feature);

	var buffer = turf.buffer(geojson, 10, 'kilometers');
	console.log(buffer);
	
	LH.addGeoJsonToLayerSource("Buffers", buffer);
	
    });
});
*/
// New dragbox interaction
var InteractionDragbox = new ol.interaction.DragBox({
    layers: function(layer) {
	return layer.get('selectable') === true;
    },
    condition: ol.events.condition.platformModifierKeyOnly
});

InteractionDragbox.on('boxend', function() {
    // Get the extent of the box
    var extent = InteractionDragbox.getGeometry().getExtent();

    $.each(LH.layers, function(layer_name, layer) {
	if(layer.getProperties().selectable === true){
	    layer.getSource().forEachFeatureIntersectingExtent(extent, function(feature) {
		SelectedFeatures.push(feature); 
	    });
	}
    });
    
    SelectedFeatures.changed();
});

// Add the interaction to the collection and to the map
Interactions.push(InteractionDragbox);

InteractionZoom = new ol.interaction.MouseWheelZoom();

Interactions.push(InteractionZoom);

// Create a layerswitcher control
var ControlLayerSwitcher = new ol.control.LayerSwitcher();

// Add the layerswitcher control to the collection of controls
//Controls.push(ControlLayerSwitcher);

// Create an popup overlay
var OverlayPopup = new ol.Overlay.Popup();

// Add the popup overlay to the collection of overlays
Overlays.push(OverlayPopup);

// The default view of the map
var View = new ol.View({
    center: ol.proj.transform([8.6, 49], 'EPSG:4326', 'EPSG:3857'),
    zoom: 10
});
 
var BaseLayer = new ol.layer.Tile({
    title: 'OSM',
    type: 'base',
    source: new ol.source.OSM()
});

// Map object
var Map = new ol.Map({
    target: 'map',
    layers: LH.mass_layer_collection,
    view: View,
    interactions: Interactions,
    controls: Controls,
    overlays: Overlays
});

/*
// TODO: Show attributes when choosing a layer
Map.on('singleclick', function(evt) {
    var prettyCoord = ol.coordinate.toStringHDMS(ol.proj.transform(evt.coordinate, 'EPSG:3857', 'EPSG:4326'), 2);
    OverlayPopup.show(evt.coordinate, "apple");
});
*/

Map.addLayer(BaseLayer); 


LH.mass_layer_collection.on('change', function(){
    
    table_of_content = {};
    
    this.forEach(function(group, index, array) {
	group.on('change', function(){
	    
	    group_layers = [];
	    
	    group.getLayers().forEach(function(layer, i, a) {
		group_layers[layer.getProperties().name] = layer.getProperties();
	    });
	    
	    group_properties = group.getProperties();
	    
	    table_of_content[group_properties.name] = {
		properties: group_properties,
		layers: group_layers
	    };
	    //current_layers = [];
	});
	
	
	console.log(table_of_content);
	
	
    });
    //console.log(table_of_content);
    


    
    /*
    $("#layer_list").html("");
    $.each(current_layers, function(key, layer) {
	console.log(layer);
	$("#layer_list").append(layer.name + "<br>");
	
    });
    */
});


LH.addGroup({
    group_title: "Group of base data",
    group_name: "base_data_group"
});

LH.addLayer({
    layer_name: "VectorLayerAdministrativeAreas",
    selectable: true,
    group_name: "base_data_group",
    title: "Administrative areas",
    data: {
	type: "path",
	source: "Data/json/poly.shp.geojson"
    }
});

LH.addLayer({
    layer_name: "VectorLayerRadiationPoi",
    selectable: true,
    group_name: "base_data_group",
    title: "Radiation Pois",
    data: {
	type: "path",
	source: "Data/json/radiation_poi.geojson"
    }
});

// USER INTERFACE

// Init draggable on the toolbar
$(function() {
    $("#gis_toolbar").draggable();
    $("#gis_layer_switcher").draggable();
    $("#sortable1, #sortable2").sortable({
	connectWith: ".connectedSortable"
    }).disableSelection();
});

BufferDialog = $("#dialog-buffer-tool").dialog({
    autoOpen: false,
    //height: 400,
    width: 600,
    modal: true,
    buttons: {
	Cancel: function() {
	    BufferDialog.dialog( "close" );
	},
	Create: function() {

	    var fields = {};
	    var errors = {};
	    
	    $.each($(this).find("#form-buffer-tool").serializeArray(), function() {
		console.log(this.value);
		 if(this.value !== ""){
		     fields[this.name] = this.value;
		 } else {
		     errors[this.name] = "This field is required";
		 }
	    });

	    if(SelectedFeatures.getLength() === 0){
		errors['selection'] = "You have to select features first!";
	    }

	   
	    if($.isEmptyObject(errors)){
		
		 LH.addLayer({
		    layer_name: fields.buffer_layer_name,
		    selectable: Boolean(fields.buffer_layer_selectable),
		    group_name: "base_data_group",
		    title: fields.buffer_layer_title,
		    data: {
			type: "geojson",
			source: turf.buffer(
			    LH.formatFeaturesToGeoJson(SelectedFeatures.getArray()),
			    fields.buffer_layer_distance,
			    fields.buffer_layer_unit
			)
		    },
		    style: new ol.style.Style({
			stroke: new ol.style.Stroke({
			    color: 'red',
			    width: 1
			}),
			fill: new ol.style.Fill({
			    color: 'rgba(255, 0, 0, 0.3)'
			})
		    })
		});
		
		BufferDialog.dialog("close");
		
	    } else {
		$.each(errors, function(field, message) {
		    
		});
	    }

	}
    },
    close: function() {
	$(this).find("#form-buffer-tool")[0].reset();
    },
    show: {
        effect: "scale",
        duration: 100
    },
    hide: {
      effect: "explode",
      duration: 200
    }

});

$("#tool_buffer").button().on( "click", function() {
    BufferDialog.dialog("open");
});

UnionDialog = $("#dialog-union-tool").dialog({
    autoOpen: false,
    //height: 400,
    width: 600,
    modal: true,
    buttons: {
	Cancel: function() {
	    UnionDialog.dialog( "close" );
	},
	Create: function() {

	    var fields = {};
	    var errors = {};
	    
	    $.each($(this).find("#form-union-tool").serializeArray(), function() {
		console.log(this.value);
		 if(this.value !== ""){
		     fields[this.name] = this.value;
		 } else {
		     errors[this.name] = "This field is required";
		 }
	    });

	    if(SelectedFeatures.getLength() === 0){
		errors['selection'] = "You have to select features first!";
	    }

	    if($.isEmptyObject(errors)){
		
		 LH.addLayer({
		    layer_name: fields.union_layer_name,
		    selectable: Boolean(fields.union_layer_selectable),
		    group_name: "base_data_group",
		    title: fields.union_layer_title,
		    style: new ol.style.Style({
			stroke: new ol.style.Stroke({
			    color: 'red',
			    width: 1
			}),
			fill: new ol.style.Fill({
			    color: 'rgba(209, 2, 255, 0.5)'
			})
		    })
		});
		
		var union;
		
		SelectedFeatures.forEach(function(feature, index, array) {
		    if (index === 0) {
			union = turf.union(LH.formatFeatureToGeoJson(SelectedFeatures.item(index+1)), LH.formatFeatureToGeoJson(SelectedFeatures.item(index)));
			index++;
		    } else {
			union = turf.union(union, LH.formatFeatureToGeoJson(SelectedFeatures.item(index)));
		    }
		});

		LH.addGeoJsonToLayerSource(fields.union_layer_name, union);

		SelectedFeatures.clear();

		UnionDialog.dialog("close");
		
	    } else {
		$.each(errors, function(field, message) {
		    
		});
	    }
	    

	}
    },
    close: function() {
	$(this).find("#form-union-tool")[0].reset();
    },
    show: {
        effect: "scale",
        duration: 100
    },
    hide: {
      effect: "explode",
      duration: 200
    }

});

$("#tool_union").button().on( "click", function() {
    UnionDialog.dialog("open");
});

WithinDialog = $("#dialog-within-tool").dialog({
    autoOpen: false,
    //height: 400,
    width: 600,
    modal: true,
    buttons: {
	Cancel: function() {
	    WithinDialog.dialog( "close" );
	},
	Create: function() {

	    var fields = {};
	    var errors = {};
	    
	    $.each($(this).find("#form-within-tool").serializeArray(), function() {

		 if(this.value !== ""){
		     fields[this.name] = this.value;
		 } else {
		     errors[this.name] = "This field is required";
		 }
	    });

	    if(SelectedFeatures.getLength() === 0){
		errors['selection'] = "You have to select features first!";
	    }

	    var within;
	
	    if($.isEmptyObject(errors)){
		
		within_style =  new ol.style.Circle({
		    radius: 20,
		    stroke: new ol.style.Stroke({
			color: 'rgba(255, 2, 2, 1)', 
			width: 1
		    }),
		    fill: new ol.style.Fill({
			 color: 'rgba(255, 2, 2, 0.5)'
		    })
		});

		LH.addLayer({
		    layer_name: fields.within_layer_name,
		    selectable: Boolean(fields.within_layer_selectable),
		    group_name: "base_data_group",
		    title: fields.within_layer_title,
		    style:  new ol.style.Style({
			image: within_style
		    })
		    
		});
		
		// do stuff
		
		// get the selected collection objects in form of array
		var arr = SelectedFeatures.getArray();
		// console.log(LH.formatFeaturesToGeoJson(arr));
		
		// console.log(LH.formatFeaturesToGeoJson(LH.layers['VectorLayerRadiationPoi'].getSource().getFeatures()));
		
		var within = turf.within(LH.formatFeaturesToGeoJson(LH.layers['VectorLayerRadiationPoi'].getSource().getFeatures()), LH.formatFeaturesToGeoJson(arr));
		
		console.log(within);
		
		LH.addGeoJsonToLayerSource(fields.within_layer_name, within);
	
		SelectedFeatures.clear();
		
		WithinDialog.dialog("close");
		
	    } else {
		$.each(errors, function(field, message) {
		    
		});
	    }
	    

	}
    },
    close: function() {
	$(this).find("#form-within-tool")[0].reset();
    },
    show: {
        effect: "scale",
        duration: 100
    },
    hide: {
      effect: "explode",
      duration: 200
    }

});

$("#tool_within").button().on( "click", function() {
    WithinDialog.dialog("open");
});

//

NearestDialog = $("#dialog-nearest-tool").dialog({
    autoOpen: false,
    //height: 400,
    width: 600,
    modal: true,
    buttons: {
	Cancel: function() {
	    NearestDialog.dialog( "close" );
	},
	Create: function() {

	    var fields = {};
	    var errors = {};
	    
	    $.each($(this).find("#form-nearest-tool").serializeArray(), function() {

		 if(this.value !== ""){
		     fields[this.name] = this.value;
		 } else {
		     errors[this.name] = "This field is required";
		 }
	    });

	    if(SelectedFeatures.getLength() === 0){
		errors['selection'] = "You have to select features first!";
	    }

	    var nearest;
	
	    if($.isEmptyObject(errors)){
		
		nearest_style =  new ol.style.Circle({
		    radius: 20,
		    stroke: new ol.style.Stroke({
			color: 'rgba(255, 2, 2, 1)', 
			width: 1
		    }),
		    fill: new ol.style.Fill({
			 color: 'rgba(255, 2, 2, 0.5)'
		    })
		});

		LH.addLayer({
		    layer_name: fields.nearest_layer_name,
		    selectable: Boolean(fields.nearest_layer_selectable),
		    group_name: "base_data_group",
		    title: fields.nearest_layer_title,
		    style:  new ol.style.Style({
			image: nearest_style
		    })
		    
		});
		
		// do stuff

		// the problem here is the selected point feature is part of the points
		//var nearest = turf.nearest(fc_str, myPoints);
	   
		//var featureId = nearest.properties.NO;
		//console.log(nearest);
		var point;
		var point_fc;
		
		SelectedFeatures.forEach(function(fc, index, array) {
		    point_fc = fc;
		    point = LH.formatFeatureToGeoJson(fc);
		});
	
		var referencelayer = LH.layers['VectorLayerRadiationPoi'];

		referencelayer.getSource().removeFeature(point_fc);
	
		var nearest = turf.nearest(point, LH.formatFeaturesToGeoJson(referencelayer.getSource().getFeatures()));
	
		LH.addGeoJsonToLayerSource(fields.nearest_layer_name, nearest);
	
		referencelayer.getSource().addFeature(point_fc);
	
		SelectedFeatures.clear();
		
		NearestDialog.dialog("close");
		
	    } else {
		$.each(errors, function(field, message) {
		    
		});
	    }
	    

	}
    },
    close: function() {
	$(this).find("#form-nearest-tool")[0].reset();
    },
    show: {
        effect: "scale",
        duration: 100
    },
    hide: {
      effect: "explode",
      duration: 200
    }

});

$("#tool_nearest").button().on( "click", function() {
    NearestDialog.dialog("open");
});

</script>


<script type="text/javascript">
   
/*
   
var format = new ol.format.GeoJSON();
var vectorSourcePoints = new ol.source.Vector();
var vectorSourceBuffer = new ol.source.Vector();
var vectorSourceDissolve = new ol.source.Vector(
	 
);

var vectorSourceAdminstrative = new ol.source.Vector({
    //strategy: ol.loadingstrategy.bbox
});

var vectorLayerPoints = new ol.layer.Vector({
    
    source: vectorSourcePoints,
    style: styleFunction
});

var vectorLayerBuffer = new ol.layer.Vector({
    source: vectorSourceBuffer,
    style: styleFunction
});	

var vectorLayerDissolve = new ol.layer.Vector({
    source: vectorSourceDissolve,
    visible: true,
    style: new ol.style.Style({
        stroke: new ol.style.Stroke({
            color: 'red',
            width: 5
        }),
        fill: new ol.style.Fill({
            color: 'rgba(255, 0, 0, 0.7)'
        })
    })
});	

var vectorLayerAdminstrative = new ol.layer.Vector({
        source: vectorSourceAdminstrative,
	style: styleFunction
});

var map = new ol.Map({
    target: 'map',
    layers: [
	new ol.layer.Tile({
	    source: new ol.source.OSM()
	}),
       
		vectorLayerAdminstrative,
		vectorLayerDissolve
		//vectorLayerBuffer,
		//vectorLayerDissolve
		//vectorLayerPoints
    ],
    view: new ol.View({
      center: ol.proj.transform([8.6, 49], 'EPSG:4326', 'EPSG:3857'),
      zoom: 10
    })
});

fetch('Data/json/radiation_poi.geojson').then(function(response) {
    return response.json().then(function(point_fc) {
	vectorSourcePoints.addFeatures(geojsonToFeatures(point_fc, {
	  featureProjection: 'EPSG:3857'
	}));
	//console.log(point_fc);
    });
    
}); 

fetch('Data/json/poly.shp.geojson').then(function(response) {
    return response.json().then(function(polys_fc) {
	vectorSourceAdminstrative.addFeatures(geojsonToFeatures(polys_fc, {
	    featureProjection: 'EPSG:3857'
	}));
	//console.log(polys_fc);
    });
});

var select = new ol.interaction.Select({
    layers: [
	//vectorLayerAdminstrative, 
	vectorSourcePoints
    ]

});

map.addInteraction(select);

var currentlySelectedFeatureCollection = select.getFeatures();

var geoJsonCollection = new ol.Collection();

// Handling selected features
currentlySelectedFeatureCollection.on('change', function(event) {
    
    geoJsonCollection.clear();

    this.forEach(function(feature, index, array) {
            geoJsonCollection.push(format.writeFeatureObject(feature, {defaultDataProjection: 'EPSG:4326', featureProjection: 'EPSG:3857', rightHanded: true}));
    });
    
    geoJsonCollection.changed();
    
}); 


geoJsonCollection.on('change', function(event) {
    
    var union; 

    var geojson_features = geoJsonCollection.getArray();
    
    for(var i = 1; i < geojson_features.length; i++){
        if (i === 1) {
            union = turf.union(geojson_features[i-1], geojson_features[i]);
        } else {
            union = turf.union(union, geojson_features[i]);
        }
    }

    var union_fc = format.readFeature(union, {dataProjection: 'EPSG:4326', featureProjection: 'EPSG:3857'});

    var correct_union_fc = format.writeFeature(union_fc, {dataProjection: 'EPSG:4326', featureProjection: 'EPSG:3857', rightHanded: true});
    
    console.log(correct_union_fc);
    
    // addFeature can handle only readFeature output. The previously used geojsonToFeatures used readFeatures.
    vectorSourceDissolve.addFeature(format.readFeature(correct_union_fc, {dataProjection: 'EPSG:4326', featureProjection: 'EPSG:3857'}));
    currentlySelectedFeatureCollection.clear();

});


select.on('select', function(){
    select.changed();
});

select.on('change', function(event){
    currentlySelectedFeatureCollection.changed();
});

var dragBox = new ol.interaction.DragBox({
    layers: [
	//vectorLayerAdminstrative, 
	vectorSourcePoints
    ],
    condition: ol.events.condition.platformModifierKeyOnly
});

map.addInteraction(dragBox);

dragBox.on('boxend', function() {

    var extent = dragBox.getGeometry().getExtent();
    
    vectorSourceAdminstrative.forEachFeatureIntersectingExtent(extent, function(feature) {
	currentlySelectedFeatureCollection.push(feature); 
    });
   
    vectorSourcePoints.forEachFeatureIntersectingExtent(extent, function(feature) {
	currentlySelectedFeatureCollection.push(feature); 
    });
    
    currentlySelectedFeatureCollection.changed();
});

dragBox.on('boxstart', function() {
    //currentlySelectedFeatureCollection.clear();
});

map.on('click', function() {
    //currentlySelectedFeatureCollection.clear();
});
*/
</script>

</body>
</html>